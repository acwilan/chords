---
import App from '../../layouts/App.astro';
import { getEntryBySlug, getCollection } from 'astro:content';

export async function getStaticPaths() {
  const songs = await getCollection('songs');
  return songs.map((song) => ({ params: { slug: song.slug } }));
}

const slug = Astro.params.slug;
const song = await getEntryBySlug('songs', slug);
if (!song) {
  throw new Error(`Song not found: ${slug}`);
}
const { Content } = await song.render();
const base = import.meta.env.BASE_URL.endsWith('/')
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`;
const pdf =
  song.data.pdf &&
  (song.data.pdf.startsWith('http')
    ? song.data.pdf
    : `${base}${song.data.pdf.replace(/^\//, '')}`);
const url = `${base}songs/${slug}/`;
const description = `Chord chart for ${song.data.title}`;
---
<App>
  <Fragment slot="head">
    <title>{song.data.title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={song.data.title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={url} />
  </Fragment>
  <header class="mb-8 border-b pb-4">
    <h1 class="mb-2 text-3xl font-bold">{song.data.title}</h1>
    <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-600 dark:text-gray-300">
      {song.data.key && (
        <span><strong>Key:</strong> {song.data.key}</span>
      )}
      {song.data.bpm && (
        <span><strong>BPM:</strong> {song.data.bpm}</span>
      )}
      {song.data.capo && (
        <span><strong>Capo:</strong> {song.data.capo}</span>
      )}
    </div>
    {song.data.tags && (
      <div class="mt-2 flex flex-wrap gap-2">
        {song.data.tags.map((tag) => (
          <span class="rounded bg-gray-200 px-2 py-1 text-xs dark:bg-gray-700">{tag}</span>
        ))}
      </div>
    )}
  </header>
  <Content />
  {pdf && (
    <>
      <div class="mt-8 flex gap-4">
        <a
          href={pdf}
          download
          class="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600"
        >
          Download PDF
        </a>
        <a
          href={pdf}
          target="_blank"
          class="rounded bg-gray-600 px-4 py-2 text-white hover:bg-gray-700 dark:bg-gray-500 dark:hover:bg-gray-600"
        >
          Open PDF
        </a>
      </div>
      <div class="mt-4 overflow-hidden rounded border border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-800">
        <object data={pdf} type="application/pdf" class="h-[80vh] w-full bg-white dark:bg-gray-900">
          <p>
            <a href={pdf}>Download PDF</a>
          </p>
        </object>
      </div>
    </>
  )}
  <p class="mt-8"><a href={`${base}songs/`}>Go back</a></p>
</App>
